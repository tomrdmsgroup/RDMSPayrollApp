<!doctype html>
btn.textContent = "Saving...";
btn.disabled = true;


try {
const q = encodeURIComponent(state.rulesLocationName);
const { resp, body } = await apiPut(`/staff/rules?locationName=${q}`, { rules });
if (!resp.ok) {
alert(`Save failed: ${body.error || "unknown_error"}`);
return;
}
btn.textContent = "Saved";
setTimeout(() => { btn.textContent = original; btn.disabled = false; }, 800);
} catch (e) {
alert(`Save failed: ${e.message || e}`);
} finally {
if (btn.textContent !== "Saved") {
btn.textContent = original;
btn.disabled = false;
}
}
}


async function loadRecapForSelected() {
const sel = document.getElementById("locationSelect");
const name = sel.value;
state.recap = null;
renderConfirmations();
if (!name) return;


const q = encodeURIComponent(name);
const { resp, body } = await apiGet(`/staff/recap?locationName=${q}`);
if (!resp.ok) {
document.getElementById("content").innerHTML = `<div class="muted">Recap error: ${body.error || "unknown_error"}</div>`;
return;
}
state.recap = body.recap || null;
renderConfirmations();
}


async function logout() {
await fetch("/auth/logout", { method: "POST", credentials: "include" });
window.location.href = "/auth/google";
}


document.getElementById("tabs").addEventListener("click", (e) => {
const tab = e.target && e.target.dataset ? e.target.dataset.tab : null;
if (!tab) return;
setActiveTab(tab);
});


document.getElementById("locationSelect").addEventListener("change", () => {
if (state.tab === "confirmations") {
loadRecapForSelected();
return;
}
if (state.tab === "rules") {
loadRulesForSelected();
return;
}
setActiveTab("confirmations");
loadRecapForSelected();
});


document.getElementById("logoutBtn").addEventListener("click", logout);


(async function boot() {
await ensureLoggedIn();
await loadLocations();
setActiveTab("confirmations");
})();
</script>
</body>
</html>
